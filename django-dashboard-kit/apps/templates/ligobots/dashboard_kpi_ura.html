{% extends "layouts/base.html" %}

{% load static %}

{% block title %} Dashboard KPI URA {% endblock %}

{% block content %}
    <div class="pc-container">
        <div class="pcoded-content">
            <div class="page-header">
                <div class="page-block">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="page-header-title">
                                <h5 class="m-b-10">Painel de controle URA</h5>
                            </div>
                            <ul class="breadcrumb">
                                <li class="breadcrumb-item"><a href="{% url 'home:home' %}"><i class="fas fa-home"></i> Home</a></li>
                                <li class="breadcrumb-item"><i class="fas fa-tachometer-alt"></i> Painel de controle URA</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <!-- [ breadcrumb ] end -->
            
            <!-- [ Filtros ] start -->
            <div class="d-flex flex-wrap align-items-center mb-4">
                <div class="me-2 mb-2 flex-grow-1">
                    <label for="kpiSelector" class="form-label mb-1" style="font-weight: 500; font-size: 0.85rem;">KPI:</label>
                    <select id="kpiSelector" class="form-select form-select-sm" style="font-size: 0.85rem; padding: 0.3rem;">
                        <option value="" disabled selected>Selecione um KPI</option>
                        <option value="1101">(11.01) % Ocupação por Atendente</option>
                        <option value="1102">(11.02) Tempo de espera para iniciar atendimento telefônico em até 1 minuto</option>
                        <option value="1104">(11.04) % Abandono de chamada externas</option>
                        <option value="1106">(11.06) Avaliação da qualidade e precisão das informações repassadas</option>
                        <option value="1201">(12.01) Tempo médio de 03 minutos de atendimento por atendente</option>
                        <option value="1202">(12.02) Tempo de espera para iniciar atendimento telefônico em até 1 minuto</option>
                        <option value="1204">(12.04) % de abandono de chamadas internas</option>
                    </select>
                </div>
        
                <div class="me-2 mb-2 flex-grow-1">
                    <label for="hospitalSelector" class="form-label mb-1" style="font-weight: 500; font-size: 0.85rem;">Hospital:</label>
                    <select id="hospitalSelector" class="form-select form-select-sm" style="font-size: 0.85rem; padding: 0.3rem;">
                        <option value="" disabled selected>Selecione um Hospital</option>
                        <option value="hosp1">Hospital Regional de São José dos Campos</option>
                        <option value="hosp2">Hospital Regional de Sorocaba</option>
                        <option value="hosp3">Hospital da Mulher</option>
                    </select>
                </div>
        
                <div class="me-2 mb-2 flex-grow-1">
                    <label for="mesSelector" class="form-label mb-1" style="font-weight: 500; font-size: 0.85rem;">Mês:</label>
                    <select id="mesSelector" class="form-select form-select-sm" style="font-size: 0.85rem; padding: 0.3rem;">
                        <option value="" disabled selected>Mês</option>
                        <option value="01">Janeiro</option>
                        <option value="02">Fevereiro</option>
                        <option value="03">Março</option>
                        <option value="04">Abril</option>
                        <option value="05">Maio</option>
                        <option value="06">Junho</option>
                        <option value="07">Julho</option>
                        <option value="08">Agosto</option>
                        <option value="09">Setembro</option>
                        <option value="10">Outubro</option>
                        <option value="11">Novembro</option>
                        <option value="12">Dezembro</option>
                    </select>
                </div>
        
                <div class="me-2 mb-2 flex-grow-1">
                    <label for="anoSelector" class="form-label mb-1" style="font-weight: 500; font-size: 0.85rem;">Ano:</label>
                    <select id="anoSelector" class="form-select form-select-sm" style="font-size: 0.85rem; padding: 0.3rem;">
                        <option value="" disabled selected>Ano</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                    </select>
                </div>
        
                <div class="mb-2">
                    <label class="form-label mb-1" style="font-weight: 500; font-size: 0.85rem; visibility: hidden;">Buscar:</label>
                    <button id="kpiSearchButton" class="btn btn-primary w-100" style="font-size: 0.85rem; padding: 0.4rem;">Buscar</button>
                </div>
            </div>
            <!-- [ Filtros ] end -->
            
            {% comment %} <div class="row">
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card bg-primary">
                        <div class="card-body">
                            <h5 class="card-title">Quantidade de URAs</h5>
                            <p class="card-text text-white font-weight-bold display-6">{{ total_uras }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card bg-success">
                        <div class="card-body">
                            <h5 class="card-title">URAs Ativas</h5>
                            <p class="card-text text-white font-weight-bold display-6">{{ uras_ativas }}</p>
                        </div>                     
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card bg-danger">
                        <div class="card-body">
                            <h5 class="card-title">URAs Inativas</h5>
                            <p class="card-text text-white font-weight-bold display-6">{{ uras_inativas }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card bg-warning">
                        <div class="card-body">
                            <h5 class="card-title">Agentes</h5>
                            <p class="card-text text-white font-weight-bold display-6">5</p>
                        </div>
                    </div>
                </div>
            </div> {% endcomment %}

            <!-- Tabela de URAs e Clientes -->
            <div class="row">
                <div class="col-lg-12 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <!-- Indicador de Atividade dos Agentes -->
                            <div class="indicator-section">
                                <button class="btn btn-info btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#explicacaoIndicadorAgentes" aria-expanded="false" aria-controls="explicacaoIndicadorAgentes">
                                    O que é este indicador? 
                                </button>
                                <div class="collapse" id="explicacaoIndicadorAgentes">
                                    <div class="alert alert-info" role="alert">
                                        Este indicador exibe a atividade dos agentes na URA, incluindo o tempo total de login, pausas e o tempo médio de atendimento. Ele ajuda a avaliar a eficiência dos agentes e a otimizar o atendimento.

                                        <strong>Importante:</strong> O Brasil está geralmente 3 horas atrás do horário UTC (UTC-3). Os horários selecionados serão ajustados para UTC ao serem enviados para a API. Por exemplo, se escolher <strong>06:00</strong> no Brasil, o horário enviado será <strong>09:00</strong> UTC.
                                    </div>
                                </div>
                            </div>
                            <p></p>
                            <!-- Filtro de Data para a Atividade dos Agentes -->
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="card-title">Atividade dos Agentes</h5>
                                <div class="buttons-container">
                                    <button id="filterButton" class="btn btn-primary">Aplicar Filtro</button>
                                    <button id="exportExcel" class="btn btn-success" style="display: none;">Excel</button>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-5">
                                    <label for="startDate">Data de Início:</label>
                                    <input type="text" id="startDate" class="form-control" placeholder="dd/mm/aaaa hh:mm">
                                </div>
                                <div class="col-md-5">
                                    <label for="endDate">Data de Fim:</label>
                                    <input type="text" id="endDate" class="form-control" placeholder="dd/mm/aaaa hh:mm">
                                </div>
                            </div>
                            <div id="loadingSpinner" style="display:none; text-align: center; margin: 10px 0;">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="sr-only">Carregando...</span>
                                </div>
                            </div>


            
                            <!-- Tabela -->
                            <div class="table-responsive">
                                <table id="tabelaAgentes" class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>Usuário</th>
                                            <th>Data</th>
                                            <th>Tempo de Login Total (horas)</th>
                                            <th>Tempo de Pausa Total (minutos)</th>
                                            <th>Quantidade de Pausas</th>
                                            <th>Horário de Login</th>
                                            <th>Horário de Logoff</th>
                                            <th>Detalhes das Pausas</th>
                                            <th>% Ocupação</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- As linhas da tabela serão preenchidas dinamicamente aqui -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            


            <!-- Indicadores de Desempenho de URA por Fila de Atendimento -->
            <div class="row">
                <div class="col-lg-12 mb-4">
                    <div class="card">
                        <div class="card-body">
                           <!-- Indicador de Desempenho por Fila de URA -->
                            <div class="indicator-section">
                                <button class="btn btn-info btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#explicacaoIndicadorFila" aria-expanded="false" aria-controls="explicacaoIndicadorFila">
                                    O que é este indicador? 
                                </button>
                                <div class="collapse" id="explicacaoIndicadorFila">
                                    <div class="alert alert-info" role="alert">
                                        Este gráfico exibe os indicadores de desempenho das URAs (Unidades de Resposta Audível) de diferentes hospitais. Ele mostra o número de chamadas recebidas, atendidas e não atendidas, assim como o tempo total e médio de espera e de conversa. Essas métricas ajudam a avaliar a eficiência do atendimento telefônico nas URAs.
                                    </div>
                                </div>
                            </div>
                            <p></p>
                            <!-- Filtro de Data para o Indicador de Tempo de Espera -->
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="card-title">Indicador de Desempenho por Fila de URA</h5>
                                <div class="buttons-container">
                                    <button id="exportExcelButton" class="btn btn-success" style="display: none;">Excel</button>
                                    <button id="filterEsperaButton" class="btn btn-primary">Aplicar Filtro</button>
                                    <button id="downloadChart" class="btn btn-warning" style="display: none;">Baixar Gráfico</button>
                                </div>
                            </div>
                            
                            
                            <div class="row mb-3">
                                <div class="col-md-5">
                                    <label for="startDateEspera">Data de Início:</label>
                                    <input type="text" id="startDateEspera" class="form-control" placeholder="dd/mm/aaaa hh:mm">
                                </div>
                                <div class="col-md-5">
                                    <label for="endDateEspera">Data de Fim:</label>
                                    <input type="text" id="endDateEspera" class="form-control" placeholder="dd/mm/aaaa hh:mm">
                                </div>
                            </div>
                            <div id="loadingSpinnerEspera" style="display:none; text-align: center; margin: 10px 0;">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="sr-only">Carregando...</span>
                                </div>
                            </div>
                            <div id="resultadoEspera">
                                <!-- Mensagem quando não houver dados -->
                                <div id="noDataMessage" class="alert alert-warning" style="display: none;">
                                    Nenhum dado encontrado para o período selecionado.
                                </div>

                                <!-- Canvas do gráfico -->
                                <canvas id="barChart"></canvas>
                                <p></p>
                                <table id="dataTable" class="display">
                                    <thead>
                                        <tr>
                                            <th>Nome da Fila</th>
                                            <th>Chamadas Recebidas</th>
                                            <th>Chamadas Atendidas</th>
                                            <th>Chamadas Não Atendidas</th>
                                            <th>Tempo Total de Espera (segundos)</th>
                                            <th>Tempo Total de Conversa (segundos)</th>
                                            <th>Tempo Médio de Espera (minutos)</th>
                                            <th>Tempo Médio de Conversa (minutos)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Dados serão preenchidos dinamicamente -->
                                    </tbody>
                                </table>
                                
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            


            <!-- Tempo médio de serviços por atendente -->
            <div class="row">
                <div class="col-lg-12 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Tempo Médio de Serviço por Atendente</h5>
                            <!-- Inputs para as datas -->
                            <div class="row mb-3">
                                <div class="col-md-5">
                                    <label for="startDateAtendente">Data de Início:</label>
                                    <input type="text" id="startDateAtendente" class="form-control" placeholder="dd/mm/aaaa hh:mm">
                                </div>
                                <div class="col-md-5">
                                    <label for="endDateAtendente">Data de Fim:</label>
                                    <input type="text" id="endDateAtendente" class="form-control" placeholder="dd/mm/aaaa hh:mm">
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button id="filterAtendenteButton" class="btn btn-primary">Aplicar Filtro</button>
                                </div>
                            </div>
                            <div id="loadingSpinnerAtendente" style="display:none; text-align: center; margin: 10px 0;">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="sr-only">Carregando...</span>
                                </div>
                            </div>
                            <!-- Container para a tabela com rolagem horizontal -->
                            <div id="resultadoAtendente" style="overflow-x: auto;">
                                <!-- A tabela será inserida aqui dinamicamente -->
                            </div>
                            <!-- Canvas para o gráfico polar -->
                            <canvas id="polarAreaChart" style="max-width: 100%; height: 400px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>


            <div class="row">
                <div class="col-lg-12 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <!-- Indicador de Tempo de Espera para Iniciar Atendimento Telefônico em até 1 minuto -->
                            <div class="indicator-section">
                                <button class="btn btn-info btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#explicacaoIndicadorTempoEspera" aria-expanded="false" aria-controls="explicacaoIndicadorTempoEspera">
                                    O que é este indicador? 
                                </button>
                                <div class="collapse" id="explicacaoIndicadorTempoEspera">
                                    <div class="alert alert-info" role="alert">
                                        Este indicador exibe a eficiência da URA (Unidade de Resposta Audível) em atender chamadas externas em até 1 minuto. Ele mostra o percentual de ligações atendidas dentro desse tempo em relação ao total de ligações recebidas.
                                        <strong>Importante:</strong> O cálculo é feito com base nas chamadas que foram atendidas em até 1 minuto, dividido pelo total de chamadas recebidas, e multiplicado por 100 para obter o percentual.
                                    </div>
                                </div>
                            </div>
                            <p></p>
                            
                            <!-- Filtro de Data para o Indicador de Tempo de Espera -->
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="card-title">Indicador de Tempo de Espera para Iniciar Atendimento em até 1 minuto</h5>
                                <div class="buttons-container">
                                    <button id="filterEspera1minutoButton" class="btn btn-primary">Aplicar Filtro</button>
                                    <button id="exportExcelEspera" class="btn btn-success" style="display: none;">Excel</button>
                                </div>
                            </div>
            
                            <div class="row mb-3">
                                <div class="col-md-5">
                                    <label for="startDateEsperaKPI1102">Data de Início:</label>
                                    <input type="text" id="startDateEsperaKPI1102" class="form-control" placeholder="dd/mm/aaaa hh:mm">
                                </div>
                                <div class="col-md-5">
                                    <label for="endDateEsperaKPI1102">Data de Fim:</label>
                                    <input type="text" id="endDateEsperaKPI1102" class="form-control" placeholder="dd/mm/aaaa hh:mm">
                                </div>
                            </div>
                            
                            <div id="loadingSpinnerEspera" style="display:none; text-align: center; margin: 10px 0;">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="sr-only">Carregando...</span>
                                </div>
                            </div> 
            
                            <!-- Aqui está o contêiner onde a tabela será renderizada -->
                            <div id="resultadoEsperaKPI1102"></div> 
                        </div>
                    </div>
                </div>
            </div>
            
            

            <!-- Gráficos lado a lado -->
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">URAs por Cliente</h5>
                            <canvas id="chart-uras-por-cliente" style="max-height: 300px;"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Distribuição de URAs por Status</h5>
                            <div style="position: relative; height:300px; width:300px; margin: 0 auto;">
                                <canvas id="chart-status-uras"></canvas>
                            </div>
                        </div>
                    </div>
                </div>                                
            </div>
            
            <!-- Tabela de URAs e Clientes -->
            <div class="row">
                <div class="col-lg-12 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="card-title">Lista de URAs</h5>
                                <button id="exportExcel" class="btn btn-sm btn-success ">Excel</button>
                            </div>
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>Cliente</th>
                                            <th>Nome da URA</th>
                                            <th>Status</th>
                                            <th>Data de Criação</th>
                                            <th>Última Atualização</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for ura in uras %}
                                            <tr>
                                                <td>{{ ura.cliente.nome }}</td>
                                                <td>{{ ura.nome }}</td>
                                                <td>{{ ura.status }}</td>
                                                <td>{{ ura.data_criacao }}</td>
                                                <td>{{ ura.data_atualizacao }}</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- [ Main Content ] end -->
        </div>
    </div>

{% endblock content %}

{% block javascripts %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

	<!-- Flatpickr JS -->
	<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- Flatpickr Locale PT -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>

    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>


    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/highcharts-more.js"></script>
    <scriptsrc="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-gauge"></script>


	<!-- Script js para graficos de ura por cliente -->

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const clientesLabels = {{ clientes_labels|safe }};
            const urasPorCliente = {{ uras_por_cliente|safe }};
            
            const ctx = document.getElementById('chart-uras-por-cliente').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: clientesLabels,
                    datasets: [{
                        label: 'URAs por Cliente',
                        data: urasPorCliente,
                        backgroundColor: 'rgba(54, 162, 235, 0.8)',
                        borderColor: 'rgba(255, 255, 255, 0.7)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(tooltipItem) {
                                    const total = urasPorCliente.reduce((a, b) => a + b, 0);
                                    const value = tooltipItem.raw;
                                    const percentage = ((value / total) * 100).toFixed(2);
                                    return `${value} URAs (${percentage}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { color: 'rgba(0, 0, 0, 0.8)' }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { display: false },
                            ticks: {
                                stepSize: 1,
                                color: 'rgba(0, 0, 0, 0.8)'
                            }
                        }
                    }
                }
            });
    
            // Configuração para o gráfico de status das URAs
            const ctxStatus = document.getElementById('chart-status-uras').getContext('2d');
            new Chart(ctxStatus, {
                type: 'doughnut',
                data: {
                    labels: ['Ativa', 'Inativa'],
                    datasets: [{
                        data: [{{ uras_ativas }}, {{ uras_inativas }}],
                        backgroundColor: ['rgba(54, 162, 235, 0.8)', 'rgba(255, 99, 132, 0.8)'],
                        borderColor: 'rgba(255, 255, 255, 0.7)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            align: 'center'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(tooltipItem) {
                                    const total = tooltipItem.dataset.data.reduce((sum, value) => sum + value, 0);
                                    const value = tooltipItem.raw;
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${tooltipItem.label}: ${percentage}%`;
                                }
                            }
                        }
                    }
                }
            });
    
            // Exportar a tabela para Excel
            document.getElementById('exportExcel').addEventListener('click', function() {
                var table = document.querySelector('.table');
                var wb = XLSX.utils.table_to_book(table, {sheet: "URAs"});
                XLSX.writeFile(wb, 'uras_clientes.xlsx');
            });
        });
    </script>
    
	<!-- Script js para tabela de Atividade dos Agentes -->

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        
            const csrftoken = getCookie('csrftoken');
        
            function formatDateToISOStringWithMilliseconds(dateString) {
                const [datePart, timePart] = dateString.split(' ');
                const [day, month, year] = datePart.split('/');
                const [hour, minute] = timePart.split(':');
                const localDate = new Date(year, month - 1, day, hour, minute);
                return localDate.toISOString();
            }
        
            function mostrarLoadingSpinner() {
                document.getElementById('loadingSpinner').style.display = 'block';
            }
        
            function esconderLoadingSpinner() {
                document.getElementById('loadingSpinner').style.display = 'none';
            }
            
        
            function buscarDadosAgentes() {
                const selectedKPI = document.getElementById('kpiSelector').value;
                let startDate, endDate;
        
                console.log("KPI Selecionado:", selectedKPI);
                if (selectedKPI === '1101') {
                    // Se o KPI 11.01 for selecionado, gera as datas de início e fim do mês inteiro
                    const selectedMes = document.getElementById('mesSelector').value;
                    const selectedAno = document.getElementById('anoSelector').value;
        
                    startDate = `${selectedAno}-${selectedMes}-01T00:00:00`;
                    endDate = new Date(selectedAno, selectedMes, 0).toISOString().replace(/T.*/, 'T23:59:59');
        
                    console.log("Datas geradas para o KPI 11.01");
                    console.log("Data de Início:", startDate);
                    console.log("Data de Fim:", endDate);
                } else {
                    // Caso contrário, utiliza as datas selecionadas manualmente
                    startDate = document.getElementById('startDate').value;
                    endDate = document.getElementById('endDate').value;
        
                    if (!startDate || !endDate) {
                        alert('Por favor, selecione ambas as datas.');
                        return;
                    }
        
                    startDate = formatDateToISOStringWithMilliseconds(startDate);
                    endDate = formatDateToISOStringWithMilliseconds(endDate);
        
                    console.log("Datas selecionadas manualmente");
                    console.log("Data de Início:", startDate);
                    console.log("Data de Fim:", endDate);
                }
        
                mostrarLoadingSpinner();
        
                const payload = {
                    dtStart: startDate,
                    dtFinish: endDate
                };
        
                console.log("Payload enviado:", payload);
        
                fetch('{{ atividades_agentes_ura_url }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify(payload)
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Dados recebidos do JSON:', JSON.stringify(data, null, 2));
                    if (data.errcode === 0) {
                        preencherTabelaAgentes(data.agent_activity_list);
                        document.getElementById('exportExcel').style.display = data.agent_activity_list.length > 0 ? 'block' : 'none';
                    } else {
                        console.error('Erro ao buscar dados:', data.errmsg);
                        document.getElementById('exportExcel').style.display = 'none';
                    }
                    esconderLoadingSpinner();
                })
                .catch(error => {
                    console.error('Erro na requisição:', error);
                    esconderLoadingSpinner();
                    document.getElementById('exportExcel').style.display = 'none';
                });
            }
        
            
            
            function preencherTabelaAgentes(dados) {
                const table = $('#tabelaAgentes').DataTable();
            
                // Limpa as linhas existentes
                table.clear();
            
                // Consolida os dados dos agentes por nome e data
                const agentesConsolidados = consolidarDadosPorAgenteEData(dados);
            
                const TEMPO_TRABALHO_ESPERADO_HORAS = 6; // 6 horas de trabalho esperado
            
                // Função para converter horas decimais para o formato HH:mm:ss
                function formatarHorasEmHHMMSS(horasDecimais) {
                    const horas = Math.floor(horasDecimais);
                    const minutosDecimais = (horasDecimais - horas) * 60;
                    const minutos = Math.floor(minutosDecimais);
                    const segundos = Math.round((minutosDecimais - minutos) * 60);
                    
                    return [
                        horas.toString().padStart(2, '0'),
                        minutos.toString().padStart(2, '0'),
                        segundos.toString().padStart(2, '0')
                    ].join(':');
                }
            
                // Adiciona novas linhas ao DataTable
                agentesConsolidados.forEach(agente => {
                    console.log("-----------");
                    console.log("Processando agente:", agente.nome, "Data:", agente.data);
            
                    // Converte o tempo total de login para horas, extraindo o número da string
                    let tempoTotalLoginHoras = parseFloat(agente.tempoTotalLogin.split(' ')[0]);
                    console.log("Tempo total de login (horas):", tempoTotalLoginHoras);
            
                    // Calcula o total de tempo de pausas particulares
                    let tempoPausasParticulares = 0;
            
                    agente.detalhesPausas.forEach(pausa => {
                        if (!pausa.includes('Desc') && !pausa.includes('Café')) {
                            console.log("Informação completa da pausa antes de separar:", pausa);
            
                            // Extrai o tempo de início e fim da pausa
                            const [inicio, fimCompleto] = pausa.split(' - ');
                            const fim = fimCompleto.split(': ')[0].trim();  // Limpa o valor de fim para remover qualquer texto adicional após o horário
            
                            console.log("Pausa Particular - Início:", inicio, "Fim:", fim);
            
                            // Verifique se as horas extraídas são válidas antes de prosseguir
                            if (!inicio || !fim) {
                                console.error("Erro: Hora de início ou fim inválida para a pausa:", pausa);
                                return; // Pule esta iteração se os valores não forem válidos
                            }
            
                            try {
                                // Calcular o tempo da pausa em horas
                                const tempoPausa = (new Date(`1970-01-01T${fim}Z`) - new Date(`1970-01-01T${inicio}Z`)) / 3600000; // Convertendo ms para horas
                                console.log("Tempo de Pausa (horas):", tempoPausa);
                                
                                if (isNaN(tempoPausa) || tempoPausa < 0) {
                                    console.error("Erro ao calcular o tempo da pausa: Início", inicio, "Fim", fim, "Pausa:", pausa);
                                } else {
                                    tempoPausasParticulares += tempoPausa;
                                }
                            } catch (e) {
                                console.error("Erro ao processar a pausa:", e, "Pausa:", pausa);
                            }
                        }
                    });
            
                    console.log("Tempo total de pausas particulares (horas):", tempoPausasParticulares);
            
                    // Subtrai o tempo das pausas particulares do tempo total de login
                    const tempoLogadoEfetivo = tempoTotalLoginHoras - tempoPausasParticulares;
                    console.log("Tempo logado efetivo (horas):", tempoLogadoEfetivo);
            
                    // Calcula a % Ocupação com a fórmula corrigida
                    const ocupacaoPercentual = ((tempoLogadoEfetivo / TEMPO_TRABALHO_ESPERADO_HORAS) * 100).toFixed(2);
                    console.log("Ocupação percentual calculada:", ocupacaoPercentual);
            
                    const tempoLogadoEfetivoFormatado = formatarHorasEmHHMMSS(tempoLogadoEfetivo);
                    console.log("Tempo logado efetivo formatado (HH:mm:ss):", tempoLogadoEfetivoFormatado);
            
                    // Formata a medição como "Tempo Logado - Ocupação: X%"
                    const medicao = `${tempoLogadoEfetivoFormatado} - Ocupação: ${ocupacaoPercentual}%`;
                    console.log("Medição formatada:", medicao);
            
                    // Adiciona a linha à tabela
                    table.row.add([
                        agente.nome || 'N/A',
                        agente.data || 'N/A',
                        agente.tempoTotalLogin,
                        agente.tempoTotalPausa.toFixed(2) + ' minutos',
                        agente.quantidadePausas || 0,
                        agente.horarioDeLogin || 'N/A',
                        agente.horarioDeLogoff || 'N/A',
                        agente.detalhesPausas.length ? agente.detalhesPausas.join('<br>') : 'Nenhuma pausa',
                        medicao  // Nova coluna com a medição formatada
                    ]);
            
                    console.log("-----------");
                });
            
                // Atualiza a exibição do DataTable
                table.draw();
            }
            
            
            
            
                    
            function consolidarDadosPorAgenteEData(dados) {
                const agentesConsolidados = [];
        
                dados.forEach(item => {
                    if (!item.login || !item.logoff || item.login === "0" || item.logoff === "0") {
                        console.warn('Login ou Logoff inválido para:', item.nome);
                        return;
                    }
        
                    const loginDate = new Date(item.login);
                    const logoffDate = new Date(item.logoff);
        
                    console.log('Login Date:', loginDate);
                    console.log('Logoff Date:', logoffDate);
        
                    if (isNaN(loginDate.getTime()) || isNaN(logoffDate.getTime())) {
                        console.warn('Datas inválidas para:', item.nome);
                        return;
                    }
        
                    const data = loginDate.toLocaleDateString('pt-BR');
                    let agenteExistente = agentesConsolidados.find(ag => ag.nome === item.nome && ag.data === data);
        
                    if (!agenteExistente) {
                        agenteExistente = {
                            nome: item.nome || 'N/A',
                            data: data,
                            primeiroLogin: loginDate,
                            ultimoLogoff: logoffDate,
                            tempoTotalPausa: 0,
                            quantidadePausas: 0,
                            detalhesPausas: new Set()
                        };
                        agentesConsolidados.push(agenteExistente);
                    } else {
                        if (loginDate < agenteExistente.primeiroLogin) {
                            agenteExistente.primeiroLogin = loginDate;
                        }
                        if (logoffDate > agenteExistente.ultimoLogoff) {
                            agenteExistente.ultimoLogoff = logoffDate;
                        }
                    }
        
                    if (Array.isArray(item.agent_pause_list)) {
                        item.agent_pause_list.forEach(pause => {
                            const pauseDuration = pause.tempo_pause / 60;
                            if (pauseDuration < 0) {
                                console.warn('Duração de pausa negativa para:', pause);
                                return;
                            }
                            const detalhePausa = `${new Date(pause.pause).toLocaleTimeString('pt-BR')} - ${new Date(pause.unpause).toLocaleTimeString('pt-BR')}: ${pause.motivo_pause}`;
                            if (!agenteExistente.detalhesPausas.has(detalhePausa)) {
                                agenteExistente.detalhesPausas.add(detalhePausa);
                                agenteExistente.tempoTotalPausa += pauseDuration;
                                agenteExistente.quantidadePausas += 1;
                            }
                        });
                    }
                });
        
                agentesConsolidados.forEach(ag => {
                    ag.detalhesPausas = Array.from(ag.detalhesPausas);
                    if (ag.primeiroLogin && ag.ultimoLogoff) {
                        console.log('Primeiro Login:', ag.primeiroLogin);
                        console.log('Último Logoff:', ag.ultimoLogoff);
        
                        const tempoTotalMs = ag.ultimoLogoff.getTime() - ag.primeiroLogin.getTime();
                        console.log('Cálculo do tempo (ms):', tempoTotalMs);
        
                        if (!isNaN(tempoTotalMs) && tempoTotalMs >= 0) {
                            const tempoTotalHoras = (tempoTotalMs / 3600000).toFixed(2);
                            console.log('Cálculo do tempo (horas):', tempoTotalHoras);
        
                            ag.tempoTotalLogin = tempoTotalHoras + ' horas';
                            ag.horarioDeLogin = ag.primeiroLogin.toLocaleTimeString('pt-BR');
                            ag.horarioDeLogoff = ag.ultimoLogoff.toLocaleTimeString('pt-BR');
                        } else {
                            console.error('Erro ao calcular o tempo total de login para:', ag.nome);
                            ag.tempoTotalLogin = 'Erro no cálculo';
                            ag.horarioDeLogin = 'N/A';
                            ag.horarioDeLogoff = 'N/A';
                        }
                    } else {
                        ag.tempoTotalLogin = 'Dados de login incompletos';
                        ag.horarioDeLogin = 'N/A';
                        ag.horarioDeLogoff = 'N/A';
                    }
                });
        
                return agentesConsolidados;
            }
            
        
            document.getElementById('filterButton').addEventListener('click', buscarDadosAgentes);
            document.getElementById('kpiSearchButton').addEventListener('click', buscarDadosAgentes);
        
            document.getElementById('exportExcel').addEventListener('click', function() {
                const table = document.getElementById('tabelaAgentes');
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.table_to_sheet(table, { raw: true });
                XLSX.utils.book_append_sheet(wb, ws, "Atividade_Agentes");
                XLSX.writeFile(wb, 'atividade_agentes.xlsx');
            });
        });
        
                                   
    </script>
	<!-- Script js para indicador de grafico de conversa, tempo de espera, atendimento etc -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            let barChartInstance;  // Variável para armazenar a instância do gráfico
            let lastFetchedData;   // Variável para armazenar os dados recuperados da API
        
            function formatDateToISOStringWithMilliseconds(dateString) {
                const [datePart, timePart] = dateString.split(' ');
                const [day, month, year] = datePart.split('/');
                const [hour, minute] = timePart.split(':');
                const localDate = new Date(year, month - 1, day, hour, minute);
                return localDate.toISOString();
            }
        
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        
            const csrftoken = getCookie('csrftoken');
        
            function mostrarLoadingSpinnerEspera() {
                document.getElementById('loadingSpinnerEspera').style.display = 'block';
            }
        
            function esconderLoadingSpinnerEspera() {
                document.getElementById('loadingSpinnerEspera').style.display = 'none';
            }
        
            function mostrarMensagemSemDados() {
                document.getElementById('noDataMessage').style.display = 'block';
                document.getElementById('barChart').style.display = 'none';
                document.getElementById('exportExcelButton').style.display = 'none';
            }
        
            function esconderMensagemSemDados() {
                document.getElementById('noDataMessage').style.display = 'none';
                document.getElementById('barChart').style.display = 'block';
                document.getElementById('exportExcelButton').style.display = 'block';
            }
        
            function buscarIndicadorTempoEspera() {
                const startDate = document.getElementById('startDateEspera').value;
                const endDate = document.getElementById('endDateEspera').value;
        
                if (!startDate || !endDate) {
                    alert('Por favor, selecione ambas as datas.');
                    return;
                }
        
                mostrarLoadingSpinnerEspera(); // Mostra o loading spinner
        
                const payload = {
                    dtStart: formatDateToISOStringWithMilliseconds(startDate),
                    dtFinish: formatDateToISOStringWithMilliseconds(endDate)
                };
        
                // console.log('Informações enviadas para a API:', JSON.stringify(payload, null, 2));
        
                fetch('{{ indicador_de_desempenho_por_fila_de_URA }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify(payload)
                })
                .then(response => response.json())
                .then(data => {
                    // console.log('Dados recebidos da API:', JSON.stringify(data, null, 2));
        
                    if (data.errcode === 0) {
                        if (!data.queue_internal_calls || data.queue_internal_calls.length === 0) {
                            mostrarMensagemSemDados();
                        } else {
                            esconderMensagemSemDados();
                            renderizarGraficoBarras(data);
                            renderizarTabela(data);  // Adiciona esta linha para preencher a tabela
                            lastFetchedData = data;  // Armazena os dados para exportação

                            // Mostra o botão "Baixar Gráfico" após o gráfico ser gerado
                            document.getElementById('downloadChart').style.display = 'block';
                        }
                    } else {
                        console.error('Erro ao buscar dados:', data.errmsg);
                    }
                    esconderLoadingSpinnerEspera(); // Esconde o loading spinner quando terminar
                })
                .catch(error => {
                    console.error('Erro na requisição:', error);
                    esconderLoadingSpinnerEspera(); // Esconde o loading spinner em caso de erro
                });
            }
        
            function renderizarGraficoBarras(data) {
                const ctx = document.getElementById('barChart').getContext('2d');
                const labels = data.queue_internal_calls.map(queue => queue.nome_fila || 'Sem Nome de Fila');
                const chamadasRecebidas = data.queue_internal_calls.map(queue => queue.recebidas);
                const chamadasAtendidas = data.queue_internal_calls.map(queue => queue.atendidas);
                const chamadasNaoAtendidas = data.queue_internal_calls.map(queue => queue.nao_atendidas);
                const tempoTotalEspera = data.queue_internal_calls.map(queue => queue.tempo_total_espera);
                const tempoTotalConversa = data.queue_internal_calls.map(queue => queue.tempo_total_conversa);
                const tempoMedioEspera = data.queue_internal_calls.map(queue => queue.tempo_medio_espera);
                const tempoMedioConversa = data.queue_internal_calls.map(queue => queue.tempo_medio_conversa);
            
                // Destrua o gráfico existente, se houver
                if (barChartInstance) {
                    barChartInstance.destroy();
                }
            
                // Crie um novo gráfico de barras
                barChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Chamadas Recebidas',
                                data: chamadasRecebidas,
                                backgroundColor: 'rgba(75, 192, 192, 0.8)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1,
                                yAxisID: 'y1',
                            },
                            {
                                label: 'Chamadas Atendidas',
                                data: chamadasAtendidas,
                                backgroundColor: 'rgba(54, 162, 235, 0.8)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1,
                                yAxisID: 'y1',
                            },
                            {
                                label: 'Chamadas Não Atendidas',
                                data: chamadasNaoAtendidas,
                                backgroundColor: 'rgba(255, 99, 132, 0.8)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1,
                                yAxisID: 'y1',
                            },
                            {
                                label: 'Tempo Total de Espera (segundos)',
                                data: tempoTotalEspera,
                                backgroundColor: 'rgba(255, 159, 64, 0.8)',
                                borderColor: 'rgba(255, 159, 64, 1)',
                                borderWidth: 1,
                                yAxisID: 'y2',
                                type: 'line'
                            },
                            {
                                label: 'Tempo Total de Conversa (segundos)',
                                data: tempoTotalConversa,
                                backgroundColor: 'rgba(153, 102, 255, 0.8)',
                                borderColor: 'rgba(153, 102, 255, 1)',
                                borderWidth: 1,
                                yAxisID: 'y2',
                                type: 'line'
                            },
                            {
                                label: 'Tempo Médio de Espera (minutos)',
                                data: tempoMedioEspera,
                                backgroundColor: 'rgba(255, 205, 86, 0.8)',
                                borderColor: 'rgba(255, 205, 86, 1)',
                                borderWidth: 1,
                                yAxisID: 'y2',
                                type: 'line'
                            },
                            {
                                label: 'Tempo Médio de Conversa (minutos)',
                                data: tempoMedioConversa,
                                backgroundColor: 'rgba(75, 192, 192, 0.8)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1,
                                yAxisID: 'y2',
                                type: 'line'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            zoom: {
                                zoom: {
                                    wheel: {
                                        enabled: true, // Habilita zoom com scroll do mouse
                                    },
                                    pinch: {
                                        enabled: true, // Habilita zoom com pinch em dispositivos móveis
                                    },
                                    mode: 'xy', // Permite zoom nos eixos x e y
                                },
                                pan: {
                                    enabled: true,
                                    mode: 'xy', // Permite pan nos eixos x e y
                                }
                            },
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                mode: 'nearest', // Captura o ponto mais próximo
                                intersect: false, // Permite capturar a tooltip mesmo quando o mouse está próximo
                                padding: 10, // Aumenta o padding para facilitar a interação
                                callbacks: {
                                    label: function(tooltipItem) {
                                        return `${tooltipItem.dataset.label}: ${tooltipItem.raw}`;
                                    }
                                }
                            }
                        },
                        hover: {
                            mode: 'nearest', // Captura o ponto mais próximo durante o hover
                            intersect: true // Permite capturar o ponto mesmo quando é pequeno
                        },
                        scales: {
                            y1: {
                                beginAtZero: true,
                                position: 'left',
                                ticks: {
                                    stepSize: 10,
                                },
                                title: {
                                    display: true,
                                    text: 'Número de Chamadas',
                                }
                            },
                            y2: {
                                beginAtZero: true,
                                position: 'right',
                                grid: {
                                    drawOnChartArea: false,
                                },
                                ticks: {
                                    stepSize: 50,
                                },
                                title: {
                                    display: true,
                                    text: 'Tempo (segundos / minutos)',
                                }
                            },
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    autoSkip: false,
                                    maxRotation: 45,
                                    minRotation: 0
                                }
                            }
                        },
                        aspectRatio: 2.5
                    }
                });
            }

            function renderizarTabela(data) {
                const tableBody = document.querySelector("#dataTable tbody");
                tableBody.innerHTML = ''; // Limpa a tabela antes de adicionar novas linhas
            
                // console.log("Dados recebidos para renderização:", data.queue_internal_calls);
            
                // Verifica se há dados disponíveis
                if (!data.queue_internal_calls || data.queue_internal_calls.length === 0) {
                    console.log("Nenhum dado encontrado para a tabela.");
                    if ($.fn.DataTable.isDataTable('#dataTable')) {
                        $('#dataTable').DataTable().clear().destroy(); // Destrói o DataTable existente se não houver dados
                    }
                    $('#dataTable').html('<tr><td colspan="8">Nenhum dado disponível</td></tr>'); // Exibe uma mensagem na tabela se não houver dados
                    return;
                }
            
                // Adiciona novas linhas à tabela
                data.queue_internal_calls.forEach(queue => {
                    // console.log("Adicionando fila:", queue.nome_fila);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${queue.nome_fila || 'Sem Nome de Fila'}</td>
                        <td>${queue.recebidas || 0}</td>
                        <td>${queue.atendidas || 0}</td>
                        <td>${queue.nao_atendidas || 0}</td>
                        <td>${queue.tempo_total_espera || 0}</td>
                        <td>${queue.tempo_total_conversa || 0}</td>
                        <td>${queue.tempo_medio_espera || 0}</td>
                        <td>${queue.tempo_medio_conversa || 0}</td>
                    `;
                    tableBody.appendChild(row);
                });
            
                // Inicializa ou reinicializa o DataTable
                if ($.fn.DataTable.isDataTable('#dataTable')) {
                    console.log("DataTable existente encontrado, destruindo...");
                    $('#dataTable').DataTable().clear().destroy(); // Limpa e destrói o DataTable existente
                }
            
                // console.log("Inicializando DataTable com novos dados.");
                $('#dataTable').DataTable({
                    responsive: true,
                    autoWidth: false,
                    pageLength: 10,
                    data: data.queue_internal_calls, // DataTable deve usar os dados fornecidos
                    columns: [
                        { title: "Nome da Fila", data: 'nome_fila' },
                        { title: "Chamadas Recebidas", data: 'recebidas' },
                        { title: "Chamadas Atendidas", data: 'atendidas' },
                        { title: "Chamadas Não Atendidas", data: 'nao_atendidas' },
                        { title: "Tempo Total de Espera (segundos)", data: 'tempo_total_espera' },
                        { title: "Tempo Total de Conversa (segundos)", data: 'tempo_total_conversa' },
                        { title: "Tempo Médio de Espera (minutos)", data: 'tempo_medio_espera' },
                        { title: "Tempo Médio de Conversa (minutos)", data: 'tempo_medio_conversa' }
                    ]
                });
            }
            
            
                    
        
            function exportarParaExcel() {
                if (!lastFetchedData || !lastFetchedData.queue_internal_calls) {
                    alert('Nenhum dado disponível para exportação.');
                    return;
                }
        
                const headers = ["Nome da Fila", "Chamadas Recebidas", "Chamadas Atendidas", "Chamadas Não Atendidas", "Tempo Total de Espera (segundos)", "Tempo Total de Conversa (segundos)", "Tempo Médio de Espera (minutos)", "Tempo Médio de Conversa (minutos)"];
        
                const rows = lastFetchedData.queue_internal_calls.map(queue => [
                    queue.nome_fila || 'Sem Nome de Fila',
                    queue.recebidas || 0,
                    queue.atendidas || 0,
                    queue.nao_atendidas || 0,
                    queue.tempo_total_espera || 0,
                    queue.tempo_total_conversa || 0,
                    queue.tempo_medio_espera || 0,
                    queue.tempo_medio_conversa || 0
                ]);
        
                const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Indicador_Tempo_Espera");
        
                XLSX.writeFile(wb, 'Indicador_Tempo_Espera.xlsx');
            }

            function downloadChartAsImage() {
                const link = document.createElement('a');
                link.href = barChartInstance.toBase64Image();
                link.download = 'grafico.png';
                link.click();
            }

            document.getElementById('downloadChart').addEventListener('click', function() {
                const link = document.createElement('a');
                link.href = barChartInstance.toBase64Image();
                link.download = 'grafico.png';
                link.click();
            });
            
        
            document.getElementById('filterEsperaButton').addEventListener('click', function() {
                buscarIndicadorTempoEspera();
            });
        
            document.getElementById('exportExcelButton').addEventListener('click', function() {
                exportarParaExcel();
            });
        
            flatpickr("#startDateEspera", {
                enableTime: true,
                dateFormat: "d/m/Y H:i",
                time_24hr: true,
                allowInput: true,
                locale: "pt"
            });
            
            flatpickr("#endDateEspera", {
                enableTime: true,
                dateFormat: "d/m/Y H:i",
                time_24hr: true,
                allowInput: true,
                locale: "pt"
            });
        });        
    </script>





    <!-- Script js para Tempo Médio de Serviço por Atendente -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let chartInstance; // Variável para armazenar a instância do gráfico
        
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        
            const csrftoken = getCookie('csrftoken');
        
            function formatDateToISOStringWithMilliseconds(dateString) {
                const [datePart, timePart] = dateString.split(' ');
                const [day, month, year] = datePart.split('/');
                const [hour, minute] = timePart.split(':');
        
                const localDate = new Date(year, month - 1, day, hour, minute);
                return localDate.toISOString();
            }
        
            function mostrarLoadingSpinner() {
                document.getElementById('loadingSpinnerAtendente').style.display = 'block';
            }
        
            function esconderLoadingSpinner() {
                document.getElementById('loadingSpinnerAtendente').style.display = 'none';
            }
        
            function buscarTempoMedioServicoPorAtendente() {
                const startDate = document.getElementById('startDateAtendente').value;
                const endDate = document.getElementById('endDateAtendente').value;
        
                if (!startDate || !endDate) {
                    alert('Por favor, selecione ambas as datas.');
                    return;
                }
        
                mostrarLoadingSpinner();
        
                const payload = {
                    dtStart: formatDateToISOStringWithMilliseconds(startDate),
                    dtFinish: formatDateToISOStringWithMilliseconds(endDate)
                };
        
                // console.log('Informações enviadas no filtro:', JSON.stringify(payload, null, 2));
        
                fetch('{{ tempo_medio_servico_por_atendente_url }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify(payload)
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Dados recebidos do JSON:', JSON.stringify(data, null, 2));
        
                    if (data.errcode === 0) {
                        console.log('Chamando renderizarTabelaTempoMedio');
                        renderizarTabelaTempoMedio(data.queue_internal_calls); // Renderiza a tabela
                        renderizarGraficoPolar(data.queue_internal_calls);     // Renderiza o gráfico polar
                    } else {
                        console.error('Erro ao buscar dados:', data.errmsg);
                    }
                    esconderLoadingSpinner();
                })
                .catch(error => {
                    console.error('Erro na requisição:', error);
                    esconderLoadingSpinner();
                });
            }
        
            function renderizarTabelaTempoMedio(dados) {

                console.log('Executando renderizarTabelaTempoMedio com dados:', dados);
                const resultado = document.getElementById('resultadoAtendente');
                resultado.innerHTML = ''; // Limpa o conteúdo anterior
            
                if (!dados || dados.length === 0) {
                    resultado.innerHTML = '<p>Nenhum dado encontrado para o intervalo de datas selecionado.</p>';
                    return;
                }
            
                // Cria a tabela
                const table = document.createElement('table');
                table.classList.add('table', 'table-striped', 'table-hover', 'table-bordered');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Número do Ramal</th>
                            <th>Nome do Atendente</th>
                            <th>Nome da Fila</th>
                            <th>Chamadas Atendidas</th>
                            <th>Tempo Total de Conversa (s)</th>
                            <th>Tempo Médio de Conversa (s)</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                `;
            
                const tbody = table.querySelector('tbody');
            
                // Preenche os dados na tabela
                dados.forEach(item => {
                    console.log('Adicionando linha para:', item);
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${item.numero || 'Sem Ramal'}</td>
                        <td>${item.nome || 'Sem Nome'}</td>
                        <td>${item.nome_fila || 'Sem Nome de Fila'}</td>
                        <td>${item.atendidas || 0}</td>
                        <td>${item.tempo_total_conversa || 0}</td>
                        <td>${item.tempo_medio_conversa || 0}</td>
                    `;
                    tbody.appendChild(tr);
                });
            
                // Anexa a tabela ao container
                resultado.appendChild(table);

                // Inicializa o DataTables na tabela
                $(table).DataTable({
                    "pageLength": 14,  // Número de linhas por página
                    "lengthMenu": [5, 10, 25, 50, 100], // Opções de linhas por página
                    "language": {
                        "url": "https://cdn.datatables.net/plug-ins/1.11.5/i18n/Portuguese-Brasil.json" // Tradução para Português
                    }
                });
            }
        
            // Definição da função renderizarGraficoPolar
            function renderizarGraficoPolar(dados) {
                const ctx = document.getElementById('polarAreaChart').getContext('2d');
                const labels = [];
                const tempoMedioConversa = [];
                const backgroundColors = [
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(255, 205, 86, 0.8)',
                    'rgba(201, 203, 207, 0.8)',
                    'rgba(54, 162, 235, 0.8)'
                ];
        
                dados.forEach(item => {
                    const numero = item.numero || 'Sem Ramal';
                    const nome = item.nome || 'Sem Nome';
                    labels.push(`${numero} - ${nome}`);
                    tempoMedioConversa.push(item.tempo_medio_conversa || 0);
                });
        
                if (chartInstance) {
                    chartInstance.destroy(); // Destrua o gráfico existente, se houver
                }
        
                chartInstance = new Chart(ctx, {
                    type: 'polarArea',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Tempo Médio de Conversa (s)',
                            data: tempoMedioConversa,
                            backgroundColor: backgroundColors.slice(0, labels.length), // Adapta o número de cores ao número de labels
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, // Evita que o gráfico expanda indefinidamente
                        scales: {
                            r: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Tempo Médio de Conversa (s)'
                                }
                            }
                        }
                    }
                });
            }
                 
            document.getElementById('filterAtendenteButton').addEventListener('click', function() {
                buscarTempoMedioServicoPorAtendente();
            });
        
            flatpickr("#startDateAtendente", {
                enableTime: true,
                dateFormat: "d/m/Y H:i",
                time_24hr: true,
                allowInput: true,
                locale: "pt"
            });
            
            flatpickr("#endDateAtendente", {
                enableTime: true,
                dateFormat: "d/m/Y H:i",
                time_24hr: true,
                allowInput: true,
                locale: "pt"
            });
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let chartInstance;
    
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
    
            const csrftoken = getCookie('csrftoken');
    
            function formatDateToISOStringWithMilliseconds(dateString) {
                const [datePart, timePart] = dateString.split(' ');
                const [day, month, year] = datePart.split('/');
                const [hour, minute] = timePart.split(':');
    
                const localDate = new Date(year, month - 1, day, hour, minute);
                return localDate.toISOString();
            }
    
            function mostrarLoadingSpinner() {
                document.getElementById('loadingSpinnerEspera').style.display = 'block';
            }
    
            function esconderLoadingSpinner() {
                document.getElementById('loadingSpinnerEspera').style.display = 'none';
            }
    
            function buscarIndicadorTempoEspera() {
                const startDate = document.getElementById('startDateEsperaKPI1102').value;
                const endDate = document.getElementById('endDateEsperaKPI1102').value;
    
                console.log('Data de Início:', startDate);
                console.log('Data de Fim:', endDate);
    
                if (!startDate || !endDate) {
                    alert('Por favor, selecione ambas as datas.');
                    return;
                }
    
                mostrarLoadingSpinner();
    
                const payload = {
                    dtStart: formatDateToISOStringWithMilliseconds(startDate),
                    dtFinish: formatDateToISOStringWithMilliseconds(endDate)
                };
    
                fetch('{{ indicador_de_desempenho_url }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify(payload)
                })
                
                .then(response => response.json())
                .then(data => {
                    console.log('Dados recebidos do JSON:', JSON.stringify(data, null, 2));
    
                    if (data.errcode === 0) {
                        console.log('Chamando renderizarTabelaIndicadorEspera');
                        renderizarTabelaIndicadorEspera(data.ura_performance);
                    } else {
                        console.error('Erro ao buscar dados:', data.errmsg);
                    }
                    esconderLoadingSpinner();
                })
                .catch(error => {
                    console.error('Erro na requisição:', error);
                    esconderLoadingSpinner();
                });
            }
    
            function calcularPercentual(atendidasCognitivaAteUmMinuto, atendidasCognitivaTotal) {
                return atendidasCognitivaTotal > 0 
                    ? ((atendidasCognitivaAteUmMinuto / atendidasCognitivaTotal) * 100).toFixed(2) 
                    : 0;
            }
    
            function cumpreMeta(percentual) {
                return percentual == 100 ? "SIM" : "NÃO";
            }
    
            function renderizarTabelaIndicadorEspera(dados) {
                console.log('Executando renderizarTabelaIndicadorEspera com dados:', dados);
                const resultado = document.getElementById('resultadoEsperaKPI1102');
                resultado.innerHTML = ''; // Limpa o conteúdo anterior
            
                if (!dados || dados.length === 0) {
                    resultado.innerHTML = '<p>Nenhum dado encontrado para o intervalo de datas selecionado.</p>';
                    return;
                }
            
                const table = document.createElement('table');
                table.classList.add('table', 'table-striped', 'table-hover', 'table-bordered');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>URA</th>
                            <th>Localidade</th>
                            <th>Detalhamento</th>
                            <th>Início</th>
                            <th>Fim</th>
                            <th>Medição</th>
                            <th>Cumpre Meta?</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;
            
                const tbody = table.querySelector('tbody');
            
                // Filtra e processa apenas ligações externas
                dados.forEach(item => {
                    if (item.tipo_atendimento === "Externo") {
                        console.log(`Processando ligação externa para URA: ${item.ura}, Data: ${item.data}`);
            
                        const percentual = calcularPercentual(item.atendidas_cognitiva_ate_um_minuto, item.atendidas_cognitiva);
                        const metaCumprida = cumpreMeta(percentual);
            
                        const uraName = item.ura.replace(' v3', '');
            
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${uraName || 'N/A'}</td>
                            <td>${item.tipo_atendimento || 'N/A'}</td>
                            <td>Dia: ${item.data || 'N/A'}</td>
                            <td>Qtd Espera Superior 1min: ${item.atendidas_cognitiva_acima_um_minuto || 0}</td>
                            <td>Qtd Espera Inf.1min / Atend direto: ${item.atendidas_cognitiva_ate_um_minuto || 0}</td>
                            <td>Ligações atendidas: ${item.atendidas_cognitiva || 0} / Atingimento: ${percentual}%</td>
                            <td>${metaCumprida}</td>
                        `;
                        tbody.appendChild(tr);
                    }
                });
            
                resultado.appendChild(table);
            
                try {
                    $(table).DataTable({
                        "pageLength": 14,
                        "lengthMenu": [5, 10, 25, 50, 100]
                    });
                } catch (error) {
                    console.error('Erro ao inicializar DataTables:', error);
                }
            }
    
            document.getElementById('filterEspera1minutoButton').addEventListener('click', function() {
                buscarIndicadorTempoEspera();
            });
    
            flatpickr("#startDateEsperaKPI1102", {
                enableTime: true,
                dateFormat: "d/m/Y H:i",
                time_24hr: true,
                allowInput: true,
                locale: "pt"
            });
    
            flatpickr("#endDateEsperaKPI1102", {
                enableTime: true,
                dateFormat: "d/m/Y H:i",
                time_24hr: true,
                allowInput: true,
                locale: "pt"
            });
        });
    </script>
    
    
        
  
          
{% endblock javascripts %}

{% block stylesheets %}
    <style>
        /* Layout Principal */
        .card {
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.2s ease;
            padding: 1rem;
        }

        .card:hover {
            box-shadow: 0 5px 7px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #343a40;
        }

        /* Breadcrumb */
        .breadcrumb {
            font-size: 1rem;
            padding: 10px 0;
            margin-bottom: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }

        .breadcrumb-item a {
            text-decoration: none;
            color: #007bff;
            transition: color 0.3s ease;
        }

        .breadcrumb-item a:hover {
            color: #0056b3;
        }

        .breadcrumb-item i {
            margin-right: 5px;
        }

        #barChart {
            width: 100%;
            min-height: 400px;
            max-height: 500px;
            height: auto;
            margin-top: 20px;
        }

        /* Card Body e Tabelas */
        .card-body {
            /* Removi max-height e overflow-y temporariamente */
            padding: 1rem;
        }

        .table-responsive {
            /* Removi max-height e overflow-y temporariamente */
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .table {
            margin-bottom: 0;
            font-size: 0.875rem;
            background-color: #fff;
        }

        .table td, .table th {
            padding: 0.5rem;
            vertical-align: middle;
            white-space: nowrap;
        }

        .table-hover tbody tr:hover {
            background-color: #f5f5f5;
        }

        /* Estilo para o seletor de KPI */
        #kpiSelector {
            width: 100%;
            padding: 0.5rem 1.5rem 0.5rem 0.75rem;
            border-radius: 5px;
            font-size: 1rem;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.12), inset 0 1px 2px rgba(0,0,0,0.24);
            border: 1px solid #ced4da;
            background-color: #fff;
            appearance: none;
            position: relative;
            background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 4 5"><path fill="#007bff" d="M2 0L0 2h4z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 0.65rem 0.65rem;
            transition: all 0.3s ease;
        }

        /* Estilo ao focar no seletor */
        #kpiSelector:focus {
            border-color: #007bff;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
            outline: none;
        }

        /* Estilo das opções no dropdown */
        #kpiSelector option {
            padding: 8px 12px;
            white-space: normal;
            font-size: 1rem;
        }

        /* Estilo do container de exibição do KPI */
        #kpiDisplay {
            margin-top: 1rem;
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 5px;
            border: 1px solid #ced4da;
        }

        #kpiTitle {
            font-weight: 600;
            color: #343a40;
            margin-bottom: 0.5rem;
        }

        #kpiValue {
            font-size: 1.25rem;
            font-weight: bold;
            color: #007bff;
        }

        /* Botões e Feedback Visual */
        .buttons-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-success {
            background: linear-gradient(135deg, #28A745 0%, #218838 100%);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            font-size: 1rem;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            min-width: 150px;
            text-align: center;
            margin-left: 10px;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
            background-color: #218838;
        }

        .btn-success:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            background-color: #1e7e34;
        }

        /* Estilo para os botões */
        .buttons-container .btn {
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            font-size: 1rem;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            min-width: 150px;
            margin-left: 10px;
            text-align: center;
        }

        .buttons-container .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
            background-color: #0056b3;
        }

        .buttons-container .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            background-color: #004085;
        }

        /* Específico para cada botão */
        #exportExcelButton {
            background: linear-gradient(135deg, #28A745 0%, #218838 100%);
        }

        #filterEsperaButton {
            background: linear-gradient(135deg, #007BFF 0%, #0056B3 100%);
        }

        #downloadChart {
            background: linear-gradient(135deg, #FFC107 0%, #E0A800 100%);
        }

        /* Gráficos */
        canvas {
            max-width: 100%;
            height: auto !important;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.15);
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .card {
                margin-bottom: 20px;
            }

            .card-body {
                max-height: none;
                overflow-y: visible;
            }

            .table-responsive {
                max-height: none;
                overflow-y: visible;
            }

            .page-header-title h5 {
                font-size: 1.2rem;
            }

            .d-flex.justify-content-between {
                flex-wrap: wrap;
            }

            .d-flex.justify-content-between.align-items-center {
                flex-direction: column;
                align-items: flex-start;
            }

            .buttons-container {
                flex-direction: column;
                align-items: stretch;
            }

            .buttons-container .btn {
                min-width: 150px;
                padding: 10px 20px;
                margin-left: 10px;
                text-align: center;
            }
        }

        /* Feedback Visual */
        .loading-spinner {
            text-align: center;
            margin: 20px 0;
        }

        .alert-info {
            margin-bottom: 10px;
        }

        .alert-success, .alert-danger {
            font-size: 0.875rem;
            padding: 0.75rem 1rem;
            margin-top: 10px;
            border-radius: 5px;
        }

        /* Outros Estilos */
        .d-flex.justify-content-between.align-items-center {
            padding-bottom: 10px;
            margin-bottom: 10px;
            border-bottom: 1px solid #e3e3e3;
        }

        #chart-agentes {
            max-height: none;
            overflow-y: visible;
            overflow-x: visible;
            padding: 20px;
            background-color: white;
        }

        #resultadoAtendente {
            max-height: none;
            overflow: visible;
        }

        #kpiSelector, #hospitalSelector {
            width: 100%;
            padding: 0.5rem 1.5rem 0.5rem 0.75rem;
            border-radius: 5px;
            font-size: 1rem;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.12), inset 0 1px 2px rgba(0,0,0,0.24);
            border: 1px solid #ced4da;
            background-color: #fff;
            appearance: none;
            position: relative;
            transition: all 0.3s ease;
        }

        #kpiSelector:focus, #hospitalSelector:focus {
            border-color: #007bff;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
            outline: none;
        }

        .indicator-section button {
            background-color: #29a3a3;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 5px 15px;
            font-size: 0.9rem;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease;
        }

        .indicator-section button:hover {
            background-color: #238d8d;
        }

        #dataTable tbody tr:nth-child(odd) {
            background-color: #f9f9f9;
        }

        #dataTable tbody tr:nth-child(even) {
            background-color: #ffffff;
        }

        #dataTable tbody tr:hover {
            background-color: #d9edf7;
            cursor: pointer;
        }

        #dataTable thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #f1f1f1;
        }

        #dataTable th {
            position: relative;
            padding-right: 25px;
        }

        #dataTable th::after {
            content: "\25B2";
            position: absolute;
            right: 8px;
            opacity: 0.6;
            font-size: 0.8em;
            transform: rotate(0);
            transition: transform 0.2s;
        }

        #dataTable th.sorting_desc::after {
            transform: rotate(180deg);
        }

        #dataTable td, #dataTable th {
            padding: 10px 15px;
            text-align: center;
            vertical-align: middle;
            font-size: 0.875rem;
        }

        #KpiCockpit {
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        #KpiCockpit h5 {
            margin-bottom: 10px;
            font-size: 1.2rem;
            color: #333;
        }

        #tabelaEspera th, #tabelaEspera td {
            text-align: center;
            vertical-align: middle;
        }

        #tabelaEspera {
            margin-top: 20px;
        }

    </style>


{% endblock stylesheets %}


